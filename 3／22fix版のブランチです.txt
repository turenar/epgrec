[はじめに]
  epgrec3/22fix版のブランチです。(実はフォーク)
  本家との互換性がなく明確に分けたいので名称を「epgrec UNA」とさせていただきます。
  "UNA"の部分は"ゆーえぬえー"と発音してください。
  当方で改造したepgrecUNA専用epgdumpの使用が必須です。オリジナルepgdumpではピクリ
  とも動きません。
  一部、環境に合わせる為にユーザーによる編集が必要です。
  またデータベースにフィールド追加および仕様変更を行いましたので本家epgrecからの
  アップデートについては諦めてください。

  PT1 DVB版ドライバー使用時は、チャンネルマップの仕様がキャラデバ版と違うようでしたら
  各自で初回起動前のチャンネルマップ編集とサービスIDの変更などをしてください。


[本家epgrecを運用状態で残して試用する場合の注意点]
  インストールの際に以下の点を注意してください。

  1.併用は、出来ません。

  2.インストールフォルダー名とepgdumpのファイル名を変更して本家epgrecと区別してください。

  3.epgrecUNAで使用するデータベースのテーブル名接頭辞"Recorder_"を変更してください。

  4.cronに登録するEPG更新スクリプトを本家epgrecかepgrecUNAのどちらかにして下さい。

  5.EPG取得と録画を行う際に、本家epgrecとepgrecUNAの双方でかち合わないように注意して
    ください。


[本家epgrecから乗り換えの場合]
  インストール前に以下の作業をしてください。本家epgrec環境を温存する場合も同様です。

  1.未実行予約を本家epgrecのUIから全削除をして下さい。DB操作だけではATのジョブが残り
    トラブルの原因となります。

  2.cronに登録するEPG更新スクリプトをepgrecUNAだけにして下さい。

  3.キーワード・録画済一覧を引き継ぎたい場合は、一旦テーブルをエクスポートしてください。
    初回起動でEPGを取得後にチャンネルとジャンルを新規DBに合わせて修正、フィールドの
    追加と並び修正をしてからインポートしてください。
    エクスポート・インポート作業についてはphpMyAdminを使用するのが簡単です。

  4.本家epgrecで使用していたデータベースのテーブルを全て削除してください。
    ただしepgrecUNAのテーブル名接頭辞"Recorder_"を変更する場合は、この限りではありません。


[インストール]
  本家epgrecとほぼ同じです。LAMPの導入・設定を含めそちらを参照してください。
  ここでは変更事項について記します。

  [MySQL]
    バージョン5.5からデフォルトのストレージエンジンがInnoDBに変更されましたが
    MyISAMに変更してください。
    /etc/my.cnf に以下の１行を追加もしくは変更してください。

     default-storage-engine=MyISAM

  [TVチューナーまわり]
  ・PT1/PT2/PT3(recpt1)
    [推奨]
      http://hg.honeyplanet.jp/pt1/ の最新に以下のパッチをあててください。
      recpt1 httpサーバ機能追加パッチ 新本家[c9b1d21c5035]以降対応版
      http://www1.axfc.net/uploader/so/3042920
      詳しくは readme.txtを

    [非推奨]
      forkを利用する場合は、recpt1に以下のパッチをあててください。
      recpt1ctlに同梱したパッチ recpt1ctl.diffをあてて下さい。

      recpt1 BSチャンネル指定追加パッチ  http://www1.axfc.net/uploader/Sc/so/375500
      recpt1 EPG用TS出力モード追加パッチ http://www1.axfc.net/uploader/Sc/so/304459&key=UNA

      httpサーバ版RC4の場合は、下記サイトにあるパッチも追加であててください。
      http://www.castanet.homeip.net/~tos/wiki/index.php?FreeBSD%A4%C7%C3%CF%A5%C7%A5%B8%A5%D3%A5%C7%A5%AA%A5%B5%A1%BC%A5%D0

      tsspritter_liteにはバッファオーバーフローのバグがありますので
      http://d.hatena.ne.jp/katauna/20121209/1354980493 のパッチかバッファを
      動的確保するパッチを探し出して適用してください。

  ・KTV-FSUSB2/FSPCIE(recfsusb2n)
    以下のパッチをあててください。epgrecUNAでの操作性が向上します。

    recfsusb2n tsspliteer_lite内蔵・httpサーバー機能追加・recpt1ctl対応パッチ
    http://www1.axfc.net/uploader/Sc/so/350440

  ・friio(recfriio)
    必要に応じて以下のパッチをあててください。
    recpt1 EPG用TS出力モード追加パッチ     http://www1.axfc.net/uploader/Sc/so/304459&key=UNA
    recfriio BS/CSチャンネル指定追加パッチ http://www1.axfc.net/uploader/Sc/so/375501

  recpt1ctl対応録画コマンドを使う方で recpt1を使用していない場合は、別途パッチ済みの
  recpt1ctlを導入してください。


  [epgdump]
    epgrecUNA専用epgdumpをインストールしてください。


  [間欠運用（省電力）]
    通常どおりcronにEPG更新スクリプト(shepherd.php)を登録してください。
    起動時終了時スクリプト(epgwakealarm.php)の登録方法は、本家epgrecと同じです。
    システムにより違いがあるため各自で調べて選択してください。

    [SysVinit]
    # cp ./init.d/epgwakealarm /etc/init.d
    # chmod 755 /etc/init.d/epgwakealarm
    # update-rc.d epgwakealarm defaults 99 01

    [upstart](コピー先はシステム依存)
    # cp ./init/epgwakealarm.conf /etc/init
    # chmod 644 /etc/init/epgwakealarm.conf

    [systemd]
    未調査


  以降は、epgrecUNAについての追加事項です。

  [初回起動前の設定変更]
    1.config.phpの編集
      [CATVの周波数変換パススルー]
        TVチューナーと録画コマンドの双方が対応している必要があります。
        また録画コマンドにより指定方法が違います。

        チャンネルマップ設定を
        'GR23' => '23'
        から
        'GR23' => 'C23'
        に変更してください。'C23'の部分はCATV業者によって違いますので各自で調べてください。

      [追加設定]
        以下の設定が増えております。コメントを参考にして使用環境に合わせて変更してください。
        最低限 "TUNER_UNIT1"と "USE_RECPT1"・$OTHER_TUNERS_CHARA だけは、設定してください。
        またHTTPDユーザーが "www-data"以外の場合は、"HTTPD_USER"と"HTTPD_GROUP"の変更をして下さい。
        "www-data"以外に変更する場合は、cronの方も忘れずに編集してください。

        define( "TUNER_UNIT1", 0 );    // 第一チューナーの各放送波の論理チューナ数(地上波･衛星波で共用 PT1が1枚なら2)
        define( "TUNER_UNIT2", 0 );    // 上記以外の論理チューナ数(未使用)
        // PT1キャラデバ版ドライバー使用時に変更すること
        define( "USE_RECPT1", FALSE );                        // recpt1使用時にTRUEにすること
        define( "RECPT1_EPG_PATCH", FALSE );                  // recpt1 EPG用TS出力モード追加パッチ使用時はTRUE
        // PTシリーズ以外のチューナーの個別設定(チューナー数に応じて増やすこと)
        $OTHER_TUNERS_CHARA = array(
            // 地デジ
            'GR' => array(
                0 => array(
                    'epgTs' => FALSE,            // EPG用TS出力対応時はTRUE
                    'cntrl' => FALSE,            // recpt1ctl対応時はTRUE
                    'httpS' => FALSE,            // httpサーバー機能対応時はTRUE
                ),
                1 => array(
                    'epgTs' => FALSE,
                    'cntrl' => FALSE,
                    'httpS' => FALSE,
                ),
            ),
            // 衛星(BS/CS)
            'BS' => array(
                0 => array(
                    'epgTs' => FALSE,
                    'cntrl' => FALSE,
                    'httpS' => FALSE,
                ),
                1 => array(
                    'epgTs' => FALSE,
                    'cntrl' => FALSE,
                    'httpS' => FALSE,
                ),
            )
        );
        // リアルタイム視聴
        define( "REALVIEW_HTTP", FALSE );                     // リアルタイム視聴を有効にするときはtrueに
        define( "REALVIEW_HTTP_PORT", "8888");                // リアルタイム視聴のポート番号
        define( "REALVIEW_PID", "/tmp/realview" );            // リアルタイム視聴チューナーPID保存テンポラリ
        // 自動キーワ－ド予約の警告設定初期値(登録キーワード毎に変更可能)
        define( 'CRITERION_CHECK', FALSE );                   // 収録時間変動
        define( 'REST_ALERT', FALSE );                        // 番組がヒットしない場合

        // EPG取得関連
        define( "HIDE_CH_EPG_GET", FALSE );                   // 非表示チャンネルのEPGを取得するならTRUE
        define( "EXTINCT_CH_AUTO_DELETE", FALSE );            // 廃止チャンネルを自動削除するならTRUE(HIDE_CH_EPG_GET=TRUE時のみに有効・メンテナンス画面あり)

        define( 'MANUAL_REV_PRIORITY', 10 );                  // 手動予約の優先度
        define( 'HTTPD_USER', 'www-data' );                   // HTTPD(apache)アカウント
        define( 'HTTPD_GROUP', 'www-data' );                  // HTTPD(apache)アカウント
        define( 'PS_CMD', 'ps -u '.HTTPD_USER.' -f' );        // HTTPD(apache)アカウントで実行中のコマンドPID取得に使用
        define( "RECPT1_CTL", "/usr/local/bin/recpt1ctl" );   // recpt1のコントロールコマンド
        define( 'FIRST_REC', 80 );                            // EPG[schedule]受信時間
        define( 'SHORT_REC', 6 );                             // EPG[p/f]受信時間
        define( 'REC_RETRY_LIMIT', 60 );                      // 録画再試行時間
        define( "GR_PT1_EPG_SIZE", (int)(1.1*1024*1024) );    // GR EPG TSファイルサイズ(PT1)
        define( "BS_PT1_EPG_SIZE", (int)(5.5*1024*1024) );    // BS EPG TSファイルサイズ(PT1)
        define( "CS_PT1_EPG_SIZE", (int)(4*1024*1024) );      // CS EPG TSファイルサイズ(PT1)
        define( "GR_OTH_EPG_SIZE", (int)(170*1024*1024) );    // GR EPG TSファイルサイズ
        define( "BS_OTH_EPG_SIZE", (int)(170*3*1024*1024) );  // BS EPG TSファイルサイズ
        define( "CS_OTH_EPG_SIZE", (int)(170*2*1024*1024) );  // CS EPG TSファイルサイズ
        define( "GR_XML_SIZE", (int)(300*1024) );             // GR EPG XMLファイルサイズ
        define( "BS_XML_SIZE", (int)(4*1024*1024) );          // BS EPG XMLファイルサイズ
        define( "TS_STREAM_RATE", 110 );                      // １分あたりのTSサイズ(MB・ストレージ残り時間計算用)

        define( "PT1_REBOOT", FALSE );                        // PT1が不安定なときにリブートするかどうか
        define( "REBOOT_CMD", 'sudo /sbin/shutdown -r now' ); // リブートコマンド

    2.do-record.shの編集
      使用チューナーに合わせた変更が必要です。同梱したものを参考に編集をしてください。
      全チューナーで Full TS受信が出来るようにして下さい。
      録画コマンドにEPG用TS出力モード追加パッチを当てた場合は、別途対応してください。
      またリアルタイム視聴を有効にした場合も対応が必要です。
      同梱したものは、PTシリーズ・KTV-FSUSB2N/FSPCIE・黒friioの組み合わせに対応しております。

    3. ./settingsにあるbs_channel.phpとcs_channel.phpの編集
      番組表のチャンネルの並びを変更したい場合は、これらのファイルにてチャンネルの並びを
      変更してください。
      未視聴チャンネルがある場合は、以下の様にチャンネル番号を"NC"に変更するとEPG取得
      対象からはずされ処理が高速化されます。

      "BS_234" => "234",    // グリーンチャンネル
                   ↓
      "BS_234" => "NC",     // グリーンチャンネル


  [初回起動中]
    step4にて初回EPG受信を元来のgetepg.phpと並列受信EPG取得スクリプトshepherd.phpの
    どちらで行うか選択してください。双方の予測時間が表示されますので参考にしてください。
    なおgetepg.phpについては、サポート対象外なのでご了承下さい。

  [初回起動後の作業]
    1.EPG定期更新スクリプトの選択
      元来のgetepg.phpとgetepg.old.phpに加え並列受信EPG取得スクリプトshepherd.phpを
      用意しました。
      shepherd.phpを選択した場合、テンポラリーを大量消費します。テンポラリーが不足する
      場合は、それに応じて同時受信数を減らしますがEPG取得完了が遅くなります。
      テンポラリー容量の目安は、PT2 1枚の場合、地上波のみ340MB・地上波+BS 850MB・
      地上波+BS+CS 1020MBです。
      2枚挿しの場合は、地上波のみ680MB・地上波+BS 1190MB・地上波+BS+CS 1700MBとなります。

      ･･･といった感じだったのですが tsspliteer_lite内蔵録画コマンドにEPG用TS出力モードを
      追加してこの問題をほぼ解決しました。（パッチは別途配布）
      これによりTSファイルの出力サイズは、地デジ80秒810KB・BS3分5.5MBと大幅に縮小されました。

      なおシステムは、shepherd.php使用を前提としていますのでgetepg.phpかgetepg.old.phpを
      選択した場合は、機能制限(録画前EPG取得更新を行わない・間欠運用（省電力）が出来ない等)や
      動作不良をおこす可能性があります。
      両スクリプトについては、通常動作を含めサポートをしませんのでご了承下さい。

    2.無効な地デジ・サブチャンネルの非表示指定
      地デジ放送波（一部、BSにもあり）には１局につき最大３つまでサービスIDが設定され
      ています。中には使われていないものもありますが明確な判別方法がありません。
      番組表上では番組データの無いチャンネルは表示しないようにしてありますが番組検索
      では選択候補として表示されます。
      これを避けるため[番組表]→[チャンネル表示]クリック→[チャンネル名]クリックで
      放送されていないサブチャンネルを非表示にしてください。


[オリジナルからの変更内容]
   1.予約重複判定をチューナー割り振りを考慮した処理に刷新(重複判定バグも解消)

   2.予約の重複判定処理に優先度判定を導入  優先度は自動キーワードごとに指定

   3.異種チューナーの混在に対応
     config.phpと do-record.shの編集が必要です。

   4.予約の開始時間を実時間で管理するように変更

   5.録画の後方糊代を重複判定に影響しないように変更

   6.重複判定で録画時間が短縮された予約には後方糊代を適用しないように変更

   7.自動キーワード予約の重複による予約漏れを番組表へのリンク付きでログに出力

   8.全ての空きチューナーで並列受信を行い高速EPG更新を行うスクリプトを用意

   9.既に始まっている番組の即時録画開始に対応

  10.放送開始まで３分を切っている予約に対応

  11.録画開始まで３分を切っているスリープ待機中の予約の取り消しに対応

  12.録画停止に対応

  13.recpt1ctl対応録画コマンドで録画している場合、別途にEPGが更新されれば録画時間延伸に対応
     録画中番組の時間延伸を行うことが出来ますが自動では行われません。
     録画している番組の直後の番組を番組ID付き予約してください。（冒頭1分でOK）
     これにより終了予定時間前にEPG更新が行われ延伸処理が行われます。
     ただしEPG取得時に空チューナーが無い場合は出来ません。

  14.サブジャンルに対応  またジャンルを１番組につき最大３つまでに拡張

  15.EPG更新と時間追従バグを修正(EPGユニーク管理（MD5)にEventIDを追加)

  16.自動キーワード予約と手動予約での個別隣接禁止指定が可能

  17.自動キーワード予約に開始時刻と終了時刻のシフト・保存ディレクトリー・録画ファイル名
     の形式を追加
     保存ディレクトリーを振り分ける場合は、それぞれの保存ディレクトリーにドライブを
     シンボリックリンクしていると残容量があっても録画が出来ない場合があるので注意

  18.番組追従性を向上（チューナーに空きがあれば録画開始前にEPGを更新・EIT[p/f]対応）

  19.番組表と予約一覧にて予約表示をチューナー毎に色分けするようにした。
     地上波・衛星波のそれぞれで４チューナーまで定義済みですがそれ以上は、CSSに
     定義追加をして下さい。

  20.録画予約一覧と番組検索に表示番組の日時にその番組の番組表へのリンクを追加

  21.予約削除ダイアグに再自動予約禁止チェックボックスと番組検索ボタンを追加

  22.番組表の予約ダイアグに再自動予約禁止・再自動予約解禁ボタンと番組検索ボタンを追加

  23.キーワード検索でNOT検索対応(Linuxでテレビ総合4のレス925のパッチを導入)
     Google検索と同じです。語彙の前にNOT接頭辞'-'を付加してください。
     語彙開始が'-'の場合(NOT検索ではない)は、語彙を'"'で括ってください。

  24.登録済み自動キーワードの編集を可能に
     自動録画キーワード管理からはNo番号を録画予約一覧からは自動ID番号をクリックすることで
     設定が入力された状態で番組検索にジャンプします。

  25.地上波デジタルのマルチ編成チャンネルに対応(Rec10版epgdumpを導入により実現)
     SD分離録画そのものは録画コマンドの対応が必要です。
     また同じ局の複数のサブチャンネルを１チューナーにまとめる処理はありませんので
     必要ならばその都度、手動予約にて対応してください。

  26.ファイル名への半角記号使用制限の緩和
     使えない半角記号は、'\'・'/'・'''・'"'の４つです。
     制限から外された半角記号の使用については十分な注意を払ってください。

  27.チャンネル登録時のサービスID(SID)入力の自動化(Rec10版epgdumpを導入により実現)

  28.衛星波の新規チャンネル登録の自動化(Rec10版epgdumpを導入により実現)
     これには既存チャンネルのサービスID(SID)変更も含まれます。

  29.衛星波の物理チャンネル変更に対応(Rec10版epgdumpを導入により実現)
     サービスID(SID)変更と同時に行われた場合は、新規チャンネル扱いとなります。

  30.リアルタイム視聴に対応(recpt1-http版の中の人が投下したパッチを拡張)
     チューナー資源管理に組み込まれているため録画開始時やEPG更新時に空きチューナーが
     ない場合はリアルタイム視聴を自動で中断します。

     リアルタイム視聴を有効にする場合は、config.phpとdo-record.shの編集が必要です。
     do-record.shについては同梱されているdo-record.shを参考にしてください。
     対象チューナーは、http配信もしくは無限録画＋stdout出力ができる物です。
     http配信ができないものについてはVLC(cvlc)でhttp配信を行います。

     操作については番組表のチャンネル名の下の「視聴」をクリックすることでASXが
     ダウンロードされ関連付けされたhttp配信対応プレイヤーで（VLC以外では未確認）
     そのチャンネルを視聴できます。
     視聴終了は、プレイヤーを終了するだけでなく録画コマンド終了とチューナー管理の
     ために番組表右上にある[視聴終了]をクリックしてください。
     httpサーバー対応録画コマンドを使用している場合、プレイヤーからチャンネル変更を
     することが出来ますが放送波変更をともなうチャンネル変更は、チューナー資源管理に
     支障がでますのでやらないで下さい。
     なおGUIの見栄えや操作性については改良する予定はありません。たぶん

  31.１番組につきprogram_id付き予約の重複制限を緩和
     ひとつの枠にまとめられた複数番組を追跡可能状態で分離録画することが出来ます。
     これに伴い自動予約キーワード間での予約の多重・排他をキーワード毎に指定できるよ
     うにしました。
     ゆるい条件などで重複予約されてしてしまう場合は、多重禁止にして優先度を他のキーワード
     より下げると重複予約が解消されます。

  32.トランスコードをシステムでサポート
     とりあえず do-record.shの呪縛から開放
     ffmpegの環境構築や設定は各自で調べてください。
     設定は、./settings/trans_config.phpで行ないます。
     トランスコード用途への利便性を追求していますが「後処理」としての使用も出来るので
     CMカットしてからトラコンとかはユーザーで工夫してください。

  33.通常運用と間欠運用（省電力）の遷移簡易化
     WUIでの設定変更だけで運用変更ができます。（当然、間欠運用のセットアップ済みであること）
     ドロップダウンメニューから一時停止・再開できます。
     ローカルでWUIを使用すると一時停止するようになっています。


[備考]
  ・Rec10版epgdumpの採用によりchannel_discのフォーマットが変わりました。
    地デジは、"GRnn"から"GRnn_サービスID"
    BSは、ONTVcodeから"BS_サービスID"
    CSは、ONTVcodeから"CS_サービスID"

  ・BSの物理チャンネル指定書式をサービスID(SID)から"BSnn_s"(nn=ノード番号,s=スロット番号)に
    変更しました。これによりBSの再編に追従できるようになります。


[論理チューナー数関連]
  地デジ・衛星それぞれ２０台まで対応(定義を変更することで拡張可能　ハード・ソフトの許す限り制限なし)
  GUI上の色分けは、地デジ・衛星それぞれ４台まで(CSSの色定義がされていないため)


[WANからのアクセスについて]
  HTTP認証が必須です。
  IPv6についてはまじめに資料を調べていないので仮対応としておきます。問題が有るようでしたら一報願います。


[追加スクリプト]
  toggleAutorec.php
    自動予約禁止フラグ切り替えスクリプト（JavaScriptから呼ばれる）

  cancelReservationForm.php
    予約キャンセルのフォームを返す（JavaScriptから呼ばれる）

  scoutEpg.php
    録画前・単チャンネルEPG取得更新スクリプト（ATから呼ばれる）

  shepherd.php
    並列受信EPG取得更新管理スクリプト管理

  sheepdog.php
    地上波EPG取得更新管理（shepherd.phpから呼ばれる）

  collie.php
    衛星波EPG取得更新管理（shepherd.phpから呼ばれる）

  airwavesSheep.php
    単チャンネルEPG取得更新スクリプト（sheepdog.php・collie.phpから呼ばれる）

  repairEpg.php
    番組構成の乱れ修正・EPG取得更新スクリプト（storeProgram.inc.phpから呼ばれる）

  watch.php
    リアルタイム視聴開始･終了スクリプト(index.htmlから呼ばれる)

  resetEXmem.php
    チューナー資源管理用共有メモリ初期化スクリプト(ツール)

  showEXmem.php
    チューナー資源管理用共有メモリ内容表示スクリプト(ツール)

  rev_test.php
    自動キーワード予約再実行スクリプト(ツール)
    '-r'既存予約全削除後予約再実行 '-rr'既存予約全削除後終了


[ライセンス]
  オリジナルに準じます。
  本家に取り込まれた場合は、その時点で当方の権利を本家に移譲します。


[免責]
  不具合修正･機能追加等の義務を負いません。(善処はします)


[不具合報告･要望など]
  適当な何かの別館 http://d.hatena.ne.jp/katauna/ にコメントを寄せてください。
  2ch・twitter・個人ブログなどでの応対は致しません。間違った情報でも放置します。

  [とりあえずやらない事案]
  ・本家recorder.phpまわりの移植
    ぶっちゃけrecorder.phpとReservation.class.phpを改造するのがめんどくさい


[今後の予定は未定]
  ・トランスコード管理
    とりあえず対応してみましたが使っていないので今後どうなるかは未定
    要望があればブログに一報ください。

    考えている仕様は、(○:実装済み △:一部未実装 ・:未着手) 
    ○現行のdo-record.shで行なう方式ではなくシステムに組み込み
    ・CPUが空いているときにトランスコードする。(CPU次第では録画と同時でも問題ないらしい・コア数で判断?)
    ・運用時の設定･トラコン視聴をGUIから行なえるようにする。
    ○エンコードフォーマット・解像度･圧縮率などの組み合わせを複数用意できるようにして
      それらから複数選択できるようにする。(保存用と持ち出し用をトラコンしたい場合とか)
    ○出力パス(主に別ストレージ)を指定できるようにする。
    △トラコン終了後にマスターTSを自動削除できるようにする。(DBのパスも消す<サムネイルに影響するので無理)
    ・変換作業禁止時間帯を設定できるようにする。
    ・実機で視聴中は、開始しないようにできるようにする。
    ○mediatombまわりも忘れずに(デバッグしてない)
